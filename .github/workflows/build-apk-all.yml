name: Build Android APK (Test APK + APK) with Whitelabel
run-name: ${{ github.actor }} is building Android APK from tikmatrix-android ðŸš€
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from in tikmatrix-android"
        required: false
        default: "main"
        type: string

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tikmatrix-desktop repository (for whitelabel configs)
        uses: actions/checkout@v3
        with:
          path: tikmatrix-desktop

      - name: Checkout tikmatrix-android repository
        uses: actions/checkout@v3
        with:
          repository: tikmatrix/tikmatrix-android
          token: ${{ secrets.AGENT_REPO_TOKEN }}
          ref: ${{ inputs.branch }}
          path: tikmatrix-android

      - name: Setup Node.js (for whitelabel scripts)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Make gradlew executable
        run: |
          chmod +x ./gradlew || true
        working-directory: tikmatrix-android

      - name: Build Official TikMatrix APKs
        run: |
          ./gradlew build
          ./gradlew packageDebugAndroidTest
          mkdir -p app/build/apk
          mv app/build/outputs/apk/debug/app-debug.apk app/build/apk/com.github.tikmatrix.apk || true
          mv app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk app/build/apk/com.github.tikmatrix.test.apk || true
        working-directory: tikmatrix-android

      - name: Upload APK to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: tikmatrix-android/app/build/apk/
          destination-dir: ./

      - name: Update Library Version
        shell: bash
        env:
          API_KEY: ${{ secrets.API_KEY }}
          VERSION: ${{ inputs.version }}
        run: |
          set -e

          # Update APK
          APK_PAYLOAD=$(cat <<EOF
          {
            "oldName": "apk",
            "oldPlatform": "generic",
            "name": "apk",
            "downloadUrl": "https://r2.niostack.com/com.github.tikmatrix.apk",
            "platform": "generic",
            "version": "${VERSION}",
            "app": "TikMatrix"
          }
          EOF
          )

          echo "Updating apk library..."
          HTTP_CODE=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST "https://api.niostack.com/ci/update_lib" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${API_KEY}" \
            -d "${APK_PAYLOAD}") || true

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "apk library updated successfully (HTTP $HTTP_CODE)"
          else
            echo "Failed to update apk library (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Update test-apk
          TEST_PAYLOAD=$(cat <<EOF
          {
            "oldName": "test-apk",
            "oldPlatform": "generic",
            "name": "test-apk",
            "downloadUrl": "https://r2.niostack.com/com.github.tikmatrix.test.apk",
            "platform": "generic",
            "version": "${VERSION}",
            "app": "TikMatrix"
          }
          EOF
          )

          echo "Updating test-apk library..."
          HTTP_CODE2=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST "https://api.niostack.com/ci/update_lib" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${API_KEY}" \
            -d "${TEST_PAYLOAD}") || true

          if [ "$HTTP_CODE2" -ge 200 ] && [ "$HTTP_CODE2" -lt 300 ]; then
            echo "test-apk library updated successfully (HTTP $HTTP_CODE2)"
          else
            echo "Failed to update test-apk library (HTTP $HTTP_CODE2)"
            exit 1
          fi

      # Build IgMatrix whitelabel APK
      - name: Build IgMatrix APK
        run: |
          cd tikmatrix-desktop
          npm install
          node scripts/build-whitelabel-apk.js IgMatrix --verbose

      - name: Upload IgMatrix APK to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: tikmatrix-android/app/build/apk/
          destination-dir: ./

      - name: Update IgMatrix APK Library Version
        shell: bash
        env:
          API_KEY: ${{ secrets.API_KEY }}
          VERSION: ${{ inputs.version }}
        run: |
          set -e

          # Update APK
          APK_PAYLOAD=$(cat <<EOF
          {
            "oldName": "apk",
            "oldPlatform": "generic",
            "name": "apk",
            "downloadUrl": "https://r2.niostack.com/com.igmatrix.apk",
            "platform": "generic",
            "version": "${VERSION}",
            "app": "IgMatrix"
          }
          EOF
          )

          echo "Updating IgMatrix apk library..."
          HTTP_CODE=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST "https://api.niostack.com/ci/update_lib" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${API_KEY}" \
            -d "${APK_PAYLOAD}") || true

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "IgMatrix apk library updated successfully (HTTP $HTTP_CODE)"
          else
            echo "Failed to update IgMatrix apk library (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Update test-apk
          TEST_PAYLOAD=$(cat <<EOF
          {
            "oldName": "test-apk",
            "oldPlatform": "generic",
            "name": "test-apk",
            "downloadUrl": "https://r2.niostack.com/com.igmatrix.test.apk",
            "platform": "generic",
            "version": "${VERSION}",
            "app": "IgMatrix"
          }
          EOF
          )

          echo "Updating IgMatrix test-apk library..."
          HTTP_CODE2=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST "https://api.niostack.com/ci/update_lib" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${API_KEY}" \
            -d "${TEST_PAYLOAD}") || true

          if [ "$HTTP_CODE2" -ge 200 ] && [ "$HTTP_CODE2" -lt 300 ]; then
            echo "IgMatrix test-apk library updated successfully (HTTP $HTTP_CODE2)"
          else
            echo "Failed to update IgMatrix test-apk library (HTTP $HTTP_CODE2)"
            exit 1
          fi
