name: Build VideoMagic - Windows
run-name: ${{ github.actor }} is building VideoMagic (Windows) ðŸš€
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from"
        required: false
        default: "main"
        type: string
  workflow_call:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from"
        required: false
        default: "main"
        type: string

permissions:
  contents: write

jobs:
  build-videomagic-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout VideoMagic repository
        uses: actions/checkout@v3
        with:
          repository: tikmatrix/video-magic
          ref: ${{ inputs.branch }}
          path: video-magic

      - name: Checkout TikMatrix Desktop (for scripts)
        uses: actions/checkout@v3
        with:
          path: tikmatrix-desktop

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            video-magic/src-tauri/target
          key: ${{ runner.os }}-cargo-videomagic-${{ hashFiles('video-magic/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-videomagic-

      - name: Build VideoMagic package
        run: |
          cd video-magic
          npm install
          .\build.ps1

      - name: Upload VideoMagic package to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./video-magic/src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update VideoMagic version
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd video-magic
          node ../tikmatrix-desktop/scripts/update-version.js --app=videomagic --app-name=VideoMagic

      - name: Clear uploaded files
        run: |
          Remove-Item -Path .\video-magic\src-tauri\target\release\bundle\msi\* -Force -Recurse

      - name: Update VideoMagic download url
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd video-magic
          node ../tikmatrix-desktop/scripts/update-download-url.js --platform=windows --distributor=OFFICIAL --app=videomagic --app-name=VideoMagic
