name: Build Matrix - Windows
run-name: ${{ github.actor }} is building Matrix (Windows) ðŸš€
on:
  workflow_call:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from"
        required: false
        default: "main"
        type: string
      build_apps:
        description: "Apps to build"
        required: false
        default: "all"
        type: string

permissions:
  contents: write

jobs:
  build-matrix-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          repository: tikmatrix/tikmatrix-pro
          token: ${{ secrets.REPO_TOKEN }}
          ref: ${{ inputs.branch }}
          path: tikmatrix-pro

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tikmatrix-pro/src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: npm install
        working-directory: tikmatrix-pro

      - name: Build TikMatrix Pro package
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix.pro' }}
        run: .\build.ps1
        working-directory: tikmatrix-pro

      - name: Upload official package to R2
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix.pro' }}
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./tikmatrix-pro/src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update version
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix.pro' }}
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd tikmatrix-pro
          node ./scripts/update-version.js --app=tikmatrix.pro --app-name='TikMatrix Pro'

      - name: Clear uploaded files
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix.pro' }}
        run: |
          Remove-Item -Path .\tikmatrix-pro\src-tauri\target\release\bundle\msi\* -Force -Recurse
      # TikMatrix whitelabel build and upload steps
      - name: Build TikMatrix whitelabel package
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        run: |
          cd tikmatrix-pro
          node ./scripts/build-whitelabel.js TikMatrix
      - name: Upload TikMatrix package to R2
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./tikmatrix-pro/src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update TikMatrix version
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd tikmatrix-pro
          node ./scripts/update-version.js --app=tikmatrix --app-name=TikMatrix

      - name: Clear uploaded files
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        run: |
          Remove-Item -Path .\tikmatrix-pro\src-tauri\target\release\bundle\msi\* -Force -Recurse

      - name: Update TikMatrix download url
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd tikmatrix-pro
          node ./scripts/update-download-url.js --platform=windows --distributor=OFFICIAL --app=tikmatrix --app-name=TikMatrix

      # IgMatrix whitelabel build and upload steps
      - name: Build IgMatrix whitelabel package
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        run: |
          cd tikmatrix-pro
          node ./scripts/build-whitelabel.js IgMatrix

      - name: Upload IgMatrix package to R2
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./tikmatrix-pro/src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update IgMatrix version
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd tikmatrix-pro
          node ./scripts/update-version.js --app=igmatrix --app-name=IgMatrix

      - name: Clear uploaded files
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        run: |
          Remove-Item -Path .\tikmatrix-pro\src-tauri\target\release\bundle\msi\* -Force -Recurse

      - name: Update IgMatrix download url
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd tikmatrix-pro
          node ./scripts/update-download-url.js --platform=windows --distributor=OFFICIAL --app=igmatrix --app-name=IgMatrix
