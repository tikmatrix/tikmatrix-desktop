name: Build Matrix - macOS
run-name: ${{ github.actor }} is building Matrix (macOS) ðŸš€
on:
  workflow_call:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from"
        required: false
        default: "main"
        type: string
      build_apps:
        description: "Apps to build"
        required: false
        default: "all"
        type: string

permissions:
  contents: write

jobs:
  build-matrix-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: npm install

      - name: Build official package
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        run: |
          chmod +x ./build.sh
          ./build.sh

      - name: Upload official package to R2
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./src-tauri/target/universal-apple-darwin/release/bundle/dmg
          destination-dir: ./

      - name: Clear uploaded files
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'tikmatrix' }}
        run: |
          rm -rf ./src-tauri/target/universal-apple-darwin/release/bundle/dmg/*

      # IgMatrix whitelabel build and upload steps
      - name: Build IgMatrix whitelabel package
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        run: |
          node scripts/build-whitelabel.js IgMatrix

      - name: Upload IgMatrix package to R2
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./src-tauri/target/universal-apple-darwin/release/bundle/dmg
          destination-dir: ./

      - name: Clear uploaded files
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        run: |
          rm -rf ./src-tauri/target/universal-apple-darwin/release/bundle/dmg/*

      - name: Update IgMatrix download url
        if: ${{ inputs.build_apps == 'all' || inputs.build_apps == 'igmatrix' }}
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-download-url.js --platform=mac --distributor=OFFICIAL --app=igmatrix --app-name=IgMatrix

      # TikZenX whitelabel build and upload steps
      # - name: Build TikZenX whitelabel package
      #   run: |
      #     node scripts/build-whitelabel.js TikZenX

      # - name: Upload TikZenX package to R2
      #   uses: ryand56/r2-upload-action@v1.4
      #   with:
      #     r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
      #     r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
      #     r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
      #     r2-bucket: matrix
      #     source-dir: ./src-tauri/target/universal-apple-darwin/release/bundle/dmg
      #     destination-dir: ./

      # - name: Clear uploaded files
      #   run: |
      #     rm -rf ./src-tauri/target/universal-apple-darwin/release/bundle/dmg/*

      # - name: Update TikZenX download url
      #   env:
      #     TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
      #     API_KEY: ${{ secrets.API_KEY }}
      #   run: |
      #     node scripts/update-download-url.js --platform=mac --distributor=OFFICIAL --app=tikzenx --app-name=TikZenX

      # Build and upload distributor packages
      - name: Build distributor packages
        run: |
          node scripts/build-distributor-packages-mac.js

      - name: Upload distributor packages to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./dist-distributors
          destination-dir: ./distributors

      - name: Clear uploaded files
        run: |
          rm -rf ./dist-distributors/*

      - name: Update distributor download urls
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-download-url.js --platform=mac --all-distributors
