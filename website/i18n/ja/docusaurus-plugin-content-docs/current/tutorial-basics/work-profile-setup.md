# ワークプロファイル設定

TikMatrixは、各デバイスに個別にワークプロファイルユーザーを設定することをサポートしており、これはエンタープライズ管理デバイスやデュアルアプリ環境で非常に便利です。

## ワークプロファイルとは

ワークプロファイルは、同じデバイス上に独立した作業環境を作成できるAndroid機能です。異なるユーザーIDを設定することで、次のことができます：

- エンタープライズ管理デバイスでTikMatrixを正常に使用
- 異なるアプリ環境に対して異なるユーザー設定を設定
- より細かいデバイス管理とパーミッション制御を実現

## Shelterツールを使用したアプリのクローン

ワークプロファイルを設定する前に、Shelterツールを使用してTikTokとTikMatrixアプリをクローンする必要があります：

### Shelterとは

Shelterは、Androidデバイスでワークプロファイルを作成および管理できるオープンソースアプリケーションです。これにより、分離された作業環境で重複アプリケーションを実行できます。

### Shelterのインストール

1. [F-Droid](https://f-droid.org/packages/net.typeblog.shelter/)または[Google Playストア](https://play.google.com/store/apps/details?id=net.typeblog.shelter)からShelterをダウンロードします
2. デバイスにShelterをインストールして開きます
3. セットアップウィザードに従ってワークプロファイルを作成します

### 必要なアプリケーションのクローン

Shelterをセットアップした後、TikTokとTikMatrixの両方のアプリをクローンする必要があります：

1. **TikTokアプリのクローン**：
   - Shelterを開いて「メイン」タブに移動します
   - アプリケーションリストでTikTokを見つけます
   - 「ワークプロファイルにクローン」ボタンをタップします
   - クローンプロセスが完了するのを待ちます

2. **TikMatrixアプリのクローン**：
   - Shelterで、アプリケーションリストからTikMatrixを見つけます
   - 「ワークプロファイルにクローン」ボタンをタップします
   - クローン操作を確認します

### クローン成功の確認

クローンが成功すると：

- アプリドロワーにブリーフケースアイコン付きのTikTokとTikMatrixの両方が表示されます
- これらはアプリケーションのワークプロファイルバージョンです
- メインプロファイル内の元のアプリケーションは変更されません

## ワークプロファイルの設定方法

### 1. デバイスツールバーを開く

デバイスが接続され、TikMatrixメインインターフェイスに表示されているとき：

1. デバイスカードをダブルクリックしてフルスクリーンモードに入ります
2. デバイス画面の右側にツールバーが表示されます
3. ツールバーはデフォルトで折りたたまれており、マウスを合わせると自動的に展開されます

### 2. ワークプロファイルボタンを見つける

ツールバーの下部に、ブリーフケースアイコンのボタンがあります。これがワークプロファイル設定ボタンです。

### 3. ユーザーIDを設定する

1. ブリーフケースアイコンボタンをクリックします
2. ポップアップダイアログにユーザーIDを入力します（例：10）
3. 「保存」ボタンをクリックします

### 4. 設定を確認する

設定が成功すると、システムは「ワークプロファイルユーザー設定が保存されました」という通知を表示します。

## ユーザーIDの説明

### 一般的なユーザーID

- **0**：プライマリユーザー（デフォルトユーザー）
- **10**：最初のワークプロファイルユーザー
- **11**：2番目のワークプロファイルユーザー
- 追加のユーザーIDはこのパターンに従います

### ユーザーIDの検索方法

デバイスのユーザーIDがわからない場合は、次の方法で見つけることができます：

```bash
adb shell pm list users
```

またはTikMatrixデバッグツールで実行：

```bash
pm list users
```

出力例：

```text
Users:
  UserInfo{0:Owner:c13} running
  UserInfo{10:Work profile:1030} running
```

## 設定ファイルのストレージ

ワークプロファイル設定は、次の形式で`data/work_profile_user.json`ファイルに自動的に保存されます：

```json
{
  "device_serial_1": "10",
  "device_serial_2": "0",
  "device_serial_3": "11"
}
```

## デバイス設定の管理

### 現在の設定を表示する

各デバイスのワークプロファイル設定は独立しています。次のことができます：

1. 各デバイスに異なるユーザーIDを設定する
2. いつでも既存のデバイスユーザー設定を変更する
3. 設定をクリアする（空の値を入力して保存すると設定が削除されます）

### バッチ管理

多数のデバイスを管理する必要がある場合は、`data/work_profile_user.json`ファイルを直接編集できます：

1. TikMatrixアプリケーションを閉じます
2. 設定ファイルを開きます
3. JSON形式でデバイス設定を追加または変更します
4. TikMatrixを再起動します

## トラブルシューティング

### 一般的な問題

#### Q：ワークプロファイルを設定した後、コマンドが失敗する

A：次を確認してください：

- ユーザーIDが正しいかどうか
- 対応するユーザーがデバイスに存在するかどうか
- そのユーザーにアクセスするための十分なパーミッションがあるかどうか

#### Q：ワークプロファイル設定をキャンセルする方法

A：設定ダイアログでユーザーID入力フィールドをクリアして保存をクリックします。

#### Q：設定が失われた場合はどうすればよいですか

A：設定はローカルJSONファイルに保存されます。失われた場合は、再設定するか、バックアップから`data/work_profile_user.json`ファイルを復元できます。

#### Q：Shelter関連の問題

A：Shelterで問題が発生した場合：

- **クローンに失敗**：管理者権限と十分なストレージスペースがあることを確認してください
- **クローンされたアプリが表示されない**：Shelterでワークプロファイルが正しくアクティブ化されているか確認してください
- **ワークプロファイルでアプリがクラッシュする**：アプリケーションを再クローンするか、Shelterを更新してみてください
- **クローンされたアプリが見つからない**：アプリドロワーでブリーフケースアイコン付きのアプリを探してください

## ベストプラクティス

### エンタープライズ環境

1. **統一管理**：すべてのエンタープライズデバイスに同じユーザーIDを設定
2. **パーミッション分離**：異なるパーミッションレベルを区別するために異なるユーザーIDを使用
3. **設定のバックアップ**：定期的に`work_profile_user.json`ファイルをバックアップ

### 個人使用

1. **アプリの分離**：異なる目的に対して異なるユーザー環境を設定
2. **テスト環境**：アプリのテストに独立したユーザーIDを使用
3. **プライバシー保護**：ユーザー分離によりプライバシーセキュリティを向上

### Shelterツール管理

1. **定期的な更新**：互換性を確保するためにShelterアプリケーションを最新の状態に保つ
2. **アプリケーションの同期**：ワークプロファイルを設定する前にTikTokとTikMatrixの両方がクローンされていることを確認
3. **Shelter設定のバックアップ**：簡単な復元のためにShelter設定をエクスポートしてバックアップ
4. **アプリの更新を監視**：TikTokまたはTikMatrixが更新されたときに、クローンされたバージョンも更新する必要がある場合があります

## 技術的な詳細

ワークプロファイル機能は、ADBコマンドに`--user`パラメータを追加することで実装されます：

```bash
# ワークプロファイルなし
adb shell input tap 100 200

# ワークプロファイル使用（ユーザーID：10）
adb shell --user 10 input tap 100 200
```

これにより、コマンドが正しいユーザー環境で実行され、パーミッションの問題と環境の競合が回避されます。

---

ワークプロファイルを適切に設定することで、さまざまな複雑なデバイス環境でTikMatrixをスムーズに使用でき、作業効率と管理の利便性が向上します。
